              	; --------------------------------------
              	; zasm: assemble "boot.asm"
              	; date: 2023-03-05 16:45:45
              	; --------------------------------------


              	;
              	;**************************************************************
              	;*
              	;*        I S H K U R   F D C   B O O T S T R A P
              	;*
              	;**************************************************************
              	;
              	
0005:         	nsec	equ	5		; # of BDOS+BIOS sectors
0037:         	mem	equ	55		; CP/M image starts at mem*1024
              					; Should be same as cpm22.asm
              	
              		; NABU bootstrap loads in at 0xC000
C000:         		org	0xC000
              		
              	; Boot start same as NABU bootstrap
              	; Not sure why the nops are here, but I am keeping them
C000: 00      	base:	nop
C001: 00      		nop
C002: 00      		nop
C003: F3      		di
C004: 3100C0  		ld	sp,base
C007: 1803    		jr	tmsini
              	
              	; Panic!
              	; Just jump to the start of ROM at this point
C009: C30000  	panic:	jp	0
              		
              		; Change TMS color mode to indicate successful boot
C00C: DBA1    	tmsini:	in	a,(0xA1)
C00E: 3EE1    		ld	a,0xE1
C010: D3A1    		out	(0xA1),a
C012: 3E87    		ld	a,0x87
C014: D3A1    		out	(0xA1),a
              	
              		; Look for the FDC
C016: 0ECF    		ld	c,0xCF
C018: ED78    	findfd:	in	a,(c)
C01A: FE10    		cp	0x10
C01C: 280A    		jr	z,drsel
C01E: 0C      		inc	c
C01F: CA09C0  		jp	z,panic
C022: 3E0F    		ld	a,0x0F
C024: 81      		add	a,c
C025: 4F      		ld	c,a
C026: 18F0    		jr	findfd
              	
              		; FDC has been found, select drive
C028: 3E02    	drsel:	ld	a,2
C02A: ED79    		out	(c),a
C02C: 06FF    		ld	b,0xFF
C02E: CD7AC0  		call	stall
              		
              		; Get command register
C031: 79      		ld	a,c
C032: D60F    		sub	0x0F
C034: 4F      		ld	c,a
C035: 3283C0  		ld	(fdaddr),a
              		
              		; Force FDC interrupt
C038: 3ED0    		ld	a,0xD0
C03A: ED79    		out	(c),a
              		
              		; Restore to track 0
              		; We should already be there, but just in case :)
C03C: 3E09    		ld	a,0x09
C03E: ED79    		out	(c),a
C040: CD7DC0  		call	fdbusy
              		
              		; Step in 1 track
              		; This should be the start of the BDOS
C043: 3E59    		ld	a,0x59
C045: ED79    		out	(c),a
C047: CD7DC0  		call	fdbusy
              		
              		; Time to read in a sector
              		; Set the sector register
C04A: 2100E4  		ld	hl,1024*(mem+2)
C04D: 3A84C0  	reads:	ld	a,(cursec)
C050: 0C      		inc	c
C051: 0C      		inc	c
C052: ED79    		out	(c),a
C054: 51      		ld	d,c
C055: 14      		inc	d
C056: 0D      		dec	c
C057: 0D      		dec	c
              		
              		; Issue read command
C058: 3E88    		ld	a,0x88
C05A: ED79    		out	(c),a
              		
              		; Wait for data to show up
C05C: ED78    	dwait:	in	a,(c)
C05E: 1F      		rra
C05F: 300B    		jr	nc,nexts
C061: 1F      		rra
C062: 30F8    		jr	nc,dwait
C064: 41      		ld	b,c		; Data is here, read it in
C065: 4A      		ld	c,d
C066: EDA2    		ini
C068: 04      		inc	b
C069: 48      		ld	c,b
C06A: 18F0    		jr	dwait
              		
              		; Move on to the next sector
C06C: 3A84C0  	nexts:	ld	a,(cursec)
C06F: FE05    		cp	nsec
              		
              		; If all sectors are in, jump to image
              		
C071: CA09E4  		jp	z,9+1024*(mem+2)
C074: 3C      		inc	a
C075: 3284C0  		ld	(cursec),a
C078: 18D3    		jr	reads
              		
              		
              	; Waits a little bit
              	;
              	; uses: b
C07A: 10FE    	stall:	djnz	stall
C07C: C9      		ret
              		
              	; Waits until FDC is not busy
              	; c = FDC command address
              	;
              	; uses: a
C07D: ED78    	fdbusy:	in	a,(c)
C07F: 1F      		rra
C080: 38FB    		jr	c,fdbusy
C082: C9      		ret
              	
              	; Variables
C083: 00      	fdaddr:	defb	0	; FDC address
C084: 01      	cursec:	defb	1	; Current sector


; +++ segments +++

#CODE          = $C000 = 49152,  size = $0085 =   133

; +++ global symbols +++

_end    = $C085 = 49285          boot.asm:14 (unused)
_size   = $0085 =   133          boot.asm:14 (unused)
base    = $C000 = 49152          boot.asm:18
cursec  = $C084 = 49284          boot.asm:134
drsel   = $C028 = 49192          boot.asm:49
dwait   = $C05C = 49244          boot.asm:93
fdaddr  = $C083 = 49283          boot.asm:133
fdbusy  = $C07D = 49277          boot.asm:127
findfd  = $C018 = 49176          boot.asm:38
mem     = $0037 =    55          boot.asm:10
nexts   = $C06C = 49260          boot.asm:106
nsec    = $0005 =     5          boot.asm:9
panic   = $C009 = 49161          boot.asm:27
reads   = $C04D = 49229          boot.asm:79
stall   = $C07A = 49274          boot.asm:120
tmsini  = $C00C = 49164          boot.asm:30


total time: 0.0018 sec.
no errors
